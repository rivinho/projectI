<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Research Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.7;
            font-weight: 300;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto 40px;
        }

        .nav-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-container {
            display: flex;
            max-width: 800px;
            margin: 0 auto 60px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .search-container:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .search-input {
            flex: 1;
            padding: 25px 30px;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 18px;
            font-weight: 400;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-input:focus {
            outline: none;
        }

        .search-btn {
            padding: 25px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .search-btn:hover {
            background: linear-gradient(135deg, #7c8ef0 0%, #8557b8 100%);
        }

        .upload-zone {
            max-width: 600px;
            margin: 0 auto 60px;
            padding: 40px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-input {
            display: none;
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .results-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .company-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            margin-bottom: 30px;
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .company-name {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #c0c0c0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .company-ticker {
            font-size: 1.2rem;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            font-weight: 600;
        }

        .metrics-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
        }

        .pre-loi-section {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 35px;
            margin: 30px 0;
        }

        .risk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .risk-low {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .risk-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .deal-score {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin: 20px 0;
        }

        .deal-score-number {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pipeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pipeline-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .pipeline-company {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .pipeline-date {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            color: #fca5a5;
        }

        .disclaimer {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-top: 40px;
        }

        .disclaimer h3 {
            color: #fcd34d;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .disclaimer p {
            color: #fde68a;
            opacity: 0.9;
            line-height: 1.6;
        }

        .stock-chart {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .trend-up {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .trend-down {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }

            .company-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .company-card {
                padding: 25px;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-tab {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <div class="header">
            <h1>Company Research</h1>
            <p>Real-time financial data, AI-powered insights & Pre-LOI analysis</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('research')">🔍 Research</button>
            <button class="nav-tab" onclick="switchTab('pipeline')">📊 Deal Pipeline</button>
            <button class="nav-tab" onclick="switchTab('industry')">🏭 Industry Comparison</button>
        </div>

        <!-- Research Tab -->
        <div id="research-tab" class="tab-content active">
            <div class="search-container">
                <input 
                    type="text" 
                    id="companySearch" 
                    class="search-input" 
                    placeholder="Search any company (e.g., AAPL, TSLA, MSFT...)"
                    autocomplete="off"
                >
                <button onclick="searchCompany()" class="search-btn">
                    Search
                </button>
            </div>

            <div class="upload-zone" onclick="document.getElementById('fileUpload').click()">
                <div class="upload-content">
                    <div class="upload-icon">📄</div>
                    <h3>Upload Company Documents</h3>
                    <p style="opacity: 0.7; margin-top: 10px;">
                        Drop CIMs, financial reports, or analysis documents here
                    </p>
                </div>
                <input type="file" id="fileUpload" class="upload-input" accept=".pdf,.doc,.docx,.txt" multiple>
            </div>

            <div id="results" class="results-section">
                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    Fetching real-time data...
                </div>
                <div id="content"></div>
            </div>
        </div>

        <!-- Pipeline Tab -->
        <div id="pipeline-tab" class="tab-content">
            <div class="company-card">
                <h2 class="section-title">📊 Deal Pipeline</h2>
                <div id="pipeline-content">
                    <div class="empty-state">
                        <h3>No companies analyzed yet</h3>
                        <p>Companies you research will automatically appear here for tracking</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Industry Comparison Tab -->
        <div id="industry-tab" class="tab-content">
            <div class="company-card">
                <h2 class="section-title">🏭 Industry Comparison</h2>
                <div id="industry-content">
                    <div class="empty-state">
                        <h3>Select companies to compare</h3>
                        <p>Research multiple companies in the same industry to see comparative analysis</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <h3>⚠️ Investment Disclaimer</h3>
            <p>
                This platform provides data for informational purposes only. Not investment advice. 
                Past performance doesn't guarantee future results. Always consult qualified financial advisors 
                before making investment decisions. We assume no liability for decisions based on this information.
            </p>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let dealPipeline = JSON.parse(localStorage.getItem('dealPipeline') || '[]');
        let currentTab = 'research';

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            if (tabName === 'pipeline') {
                loadPipeline();
            } else if (tabName === 'industry') {
                loadIndustryComparison();
            }
        }

        function loadPipeline() {
            const pipelineContent = document.getElementById('pipeline-content');
            
            if (dealPipeline.length === 0) {
                pipelineContent.innerHTML = `
                    <div class="empty-state">
                        <h3>No companies analyzed yet</h3>
                        <p>Companies you research will automatically appear here for tracking</p>
                    </div>
                `;
                return;
            }

            const pipelineHTML = dealPipeline.map(company => `
                <div class="pipeline-item" onclick="loadCompanyFromPipeline('${company.symbol}')">
                    <div>
                        <div class="pipeline-company">${company.name} (${company.symbol})</div>
                        <div class="pipeline-date">Analyzed: ${company.date}</div>
                    </div>
                    <div class="deal-score-number" style="font-size: 1.5rem;">${company.dealScore}/100</div>
                </div>
            `).join('');

            pipelineContent.innerHTML = pipelineHTML;
        }

        function loadIndustryComparison() {
            const industryContent = document.getElementById('industry-content');
            
            if (dealPipeline.length < 2) {
                industryContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Need 2+ companies for comparison</h3>
                        <p>Research multiple companies to see industry benchmarking and comparative analysis</p>
                    </div>
                `;
                return;
            }

            // Group by industry (simplified for demo)
            const industries = {};
            dealPipeline.forEach(company => {
                const industry = company.industry || 'Technology';
                if (!industries[industry]) industries[industry] = [];
                industries[industry].push(company);
            });

            const comparisonHTML = Object.keys(industries).map(industry => `
                <div class="analysis-card">
                    <div class="analysis-title">${industry} Sector</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Companies Analyzed</div>
                            <div class="metric-value">${industries[industry].length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Deal Score</div>
                            <div class="metric-value">${Math.round(industries[industry].reduce((sum, c) => sum + c.dealScore, 0) / industries[industry].length)}/100</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        ${industries[industry].map(c => `<span style="margin-right: 15px; opacity: 0.8;">${c.symbol}</span>`).join('')}
                    </div>
                </div>
            `).join('');

            industryContent.innerHTML = `
                <div class="analysis-grid">
                    ${comparisonHTML}
                </div>
            `;
        }

        function addToPipeline(companyData) {
            const existingIndex = dealPipeline.findIndex(c => c.symbol === companyData.symbol);
            const pipelineItem = {
                name: companyData.name,
                symbol: companyData.symbol,
                dealScore: calculateDealScore(companyData),
                date: new Date().toLocaleDateString(),
                industry: getIndustry(companyData.symbol),
                data: companyData
            };

            if (existingIndex >= 0) {
                dealPipeline[existingIndex] = pipelineItem;
            } else {
                dealPipeline.push(pipelineItem);
            }

            localStorage.setItem('dealPipeline', JSON.stringify(dealPipeline));
        }

        function calculateDealScore(data) {
            let score = 50; // Base score
            
            // Profitability (25 points)
            if (parseFloat(data.financials.ebitdaMargin) > 20) score += 25;
            else if (parseFloat(data.financials.ebitdaMargin) > 10) score += 15;
            else if (parseFloat(data.financials.ebitdaMargin) > 0) score += 8;
            
            // Growth (15 points) - simplified
            if (data.stockInfo.trend === 'up') score += 15;
            
            // Valuation (10 points)
            if (data.stockInfo.peRatio < 25) score += 10;
            else if (data.stockInfo.peRatio < 35) score += 5;
            
            return Math.min(100, Math.max(0, score));
        }

        function getIndustry(symbol) {
            const industries = {
                'AAPL': 'Technology',
                'TSLA': 'Automotive',
                'MSFT': 'Technology',
                'COST': 'Retail'
            };
            return industries[symbol] || 'Technology';
        }

        // File upload handling
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 2) {
                alert('Maximum 2 files allowed');
                return;
            }
            uploadedFiles = files;
            updateUploadDisplay();
        });

        function updateUploadDisplay() {
            const uploadZone = document.querySelector('.upload-zone');
            const uploadContent = document.querySelector('.upload-content');
            
            if (uploadedFiles.length > 0) {
                uploadContent.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <h3>${uploadedFiles.length} Document${uploadedFiles.length > 1 ? 's' : ''} Ready</h3>
                    <p style="opacity: 0.7; margin-top: 10px;">
                        ${uploadedFiles.map(f => f.name).join(', ')}
                    </p>
                `;
                uploadZone.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                uploadZone.style.background = 'rgba(34, 197, 94, 0.1)';
            }
        }

        // API Configuration - Replace with your actual API keys
        const ALPHA_VANTAGE_API_KEY = 'YOUR_ALPHA_VANTAGE_KEY'; // Get from alphavantage.co
        const GEMINI_API_KEY = 'AIzaSyBgSU2MlIkqyNmimexiPc2faQNhRGwWnYE'; // Your Gemini key (regenerate for security)

        // Real company data fetching
        async function searchCompany() {
            const searchTerm = document.getElementById('companySearch').value.trim().toUpperCase();
            
            if (!searchTerm) {
                alert('Please enter a company symbol (e.g., AAPL, TSLA, MSFT)');
                return;
            }

            const resultsSection = document.getElementById('results');
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');

            resultsSection.style.display = 'block';
            loading.style.display = 'block';
            content.innerHTML = '';

            try {
                const companyData = await fetchCompanyData(searchTerm);
                loading.style.display = 'none';
                displayCompanyData(companyData);
                addToPipeline(companyData);
            } catch (error) {
                loading.style.display = 'none';
                displayError(error.message);
            }
        }

        async function fetchCompanyData(symbol) {
            // Check cache first
            const cacheKey = `company_${symbol}`;
            const cached = getFromCache(cacheKey);
            if (cached) {
                console.log('Using cached data for', symbol);
                return cached;
            }

            try {
                // Try Alpha Vantage first
                if (ALPHA_VANTAGE_API_KEY !== 'YOUR_ALPHA_VANTAGE_KEY') {
                    const alphaData = await fetchFromAlphaVantage(symbol);
                    if (alphaData) {
                        setCache(cacheKey, alphaData, 3600000); // Cache for 1 hour
                        return alphaData;
                    }
                }
            } catch (error) {
                console.log('Alpha Vantage failed, using mock data:', error.message);
            }

            // Fallback to mock data for demo
            const mockData = {
                'AAPL': {
                    name: 'Apple Inc.',
                    symbol: 'AAPL',
                    price: 178.18,
                    change: 2.34,
                    changePercent: 1.33,
                    financials: {
                        revenue: '394.33B',
                        ebitda: '123.15B',
                        ebitdaMargin: '31.2%',
                        grossProfit: '169.15B',
                        grossMargin: '42.9%'
                    },
                    stockInfo: {
                        high52Week: 198.23,
                        low52Week: 124.17,
                        avgVolume: '58.2M',
                        marketCap: '2.79T',
                        peRatio: 28.1,
                        trend: 'up'
                    }
                },
                'TSLA': {
                    name: 'Tesla, Inc.',
                    symbol: 'TSLA',
                    price: 238.45,
                    change: -5.67,
                    changePercent: -2.32,
                    financials: {
                        revenue: '96.77B',
                        ebitda: '11.5B',
                        ebitdaMargin: '11.9%',
                        grossProfit: '17.7B',
                        grossMargin: '18.3%'
                    },
                    stockInfo: {
                        high52Week: 299.29,
                        low52Week: 138.80,
                        avgVolume: '112.5M',
                        marketCap: '756.8B',
                        peRatio: 67.3,
                        trend: 'down'
                    }
                },
                'MSFT': {
                    name: 'Microsoft Corporation',
                    symbol: 'MSFT',
                    price: 378.85,
                    change: 4.12,
                    changePercent: 1.10,
                    financials: {
                        revenue: '211.92B',
                        ebitda: '89.7B',
                        ebitdaMargin: '42.3%',
                        grossProfit: '146.05B',
                        grossMargin: '68.9%'
                    },
                    stockInfo: {
                        high52Week: 384.30,
                        low52Week: 213.43,
                        avgVolume: '23.8M',
                        marketCap: '2.81T',
                        peRatio: 32.7,
                        trend: 'up'
                    }
                },
                'COST': {
                    name: 'Costco Wholesale Corporation',
                    symbol: 'COST',
                    price: 567.23,
                    change: 8.45,
                    changePercent: 1.51,
                    financials: {
                        revenue: '242.29B',
                        ebitda: '9.1B',
                        ebitdaMargin: '3.8%',
                        grossProfit: '30.4B',
                        grossMargin: '12.5%'
                    },
                    stockInfo: {
                        high52Week: 588.50,
                        low52Week: 478.54,
                        avgVolume: '2.1M',
                        marketCap: '251.2B',
                        peRatio: 38.9,
                        trend: 'up'
                    }
                }
            };

            if (mockData[symbol]) {
                const data = mockData[symbol];
                setCache(cacheKey, data, 3600000); // Cache mock data too
                return data;
            } else {
                throw new Error(`Company ${symbol} not found. For demo: try AAPL, TSLA, MSFT, or COST. For real data, add your Alpha Vantage API key.`);
            }
        }

        // Alpha Vantage API Integration
        async function fetchFromAlphaVantage(symbol) {
            const urls = {
                overview: `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`,
                quote: `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`
            };

            try {
                const [overviewResponse, quoteResponse] = await Promise.all([
                    fetch(urls.overview),
                    fetch(urls.quote)
                ]);

                const overviewData = await overviewResponse.json();
                const quoteData = await quoteResponse.json();

                // Check for API errors
                if (overviewData['Error Message'] || overviewData['Note']) {
                    throw new Error('API limit reached or invalid symbol');
                }

                // Transform Alpha Vantage data to our format
                const quote = quoteData['Global Quote'];
                const overview = overviewData;

                return {
                    name: overview.Name,
                    symbol: overview.Symbol,
                    price: parseFloat(quote['05. price']).toFixed(2),
                    change: parseFloat(quote['09. change']).toFixed(2),
                    changePercent: parseFloat(quote['10. change percent'].replace('%', '')).toFixed(2),
                    financials: {
                        revenue: formatNumber(overview.RevenueTTM) || 'N/A',
                        ebitda: formatNumber(overview.EBITDA) || 'N/A',
                        ebitdaMargin: overview.ProfitMargin ? `${(parseFloat(overview.ProfitMargin) * 100).toFixed(1)}%` : 'N/A',
                        grossProfit: formatNumber(overview.GrossProfitTTM) || 'N/A',
                        grossMargin: overview.GrossProfitTTM && overview.RevenueTTM ? 
                            `${((parseFloat(overview.GrossProfitTTM) / parseFloat(overview.RevenueTTM)) * 100).toFixed(1)}%` : 'N/A'
                    },
                    stockInfo: {
                        high52Week: parseFloat(overview['52WeekHigh']).toFixed(2),
                        low52Week: parseFloat(overview['52WeekLow']).toFixed(2),
                        avgVolume: formatNumber(overview.SharesOutstanding),
                        marketCap: formatNumber(overview.MarketCapitalization),
                        peRatio: parseFloat(overview.PERatio).toFixed(1),
                        trend: parseFloat(quote['09. change']) > 0 ? 'up' : 'down'
                    }
                };
            } catch (error) {
                console.error('Alpha Vantage API error:', error);
                throw error;
            }
        }

        // Helper functions for API data
        function formatNumber(num) {
            if (!num || num === 'None') return null;
            const billion = 1000000000;
            const million = 1000000;
            const value = parseFloat(num);
            
            if (value >= billion) {
                return `${(value / billion).toFixed(1)}B`;
            } else if (value >= million) {
                return `${(value / million).toFixed(1)}M`;
            }
            return value.toLocaleString();
        }

        // Caching system
        function setCache(key, data, ttl) {
            const item = {
                data: data,
                timestamp: Date.now(),
                ttl: ttl
            };
            localStorage.setItem(key, JSON.stringify(item));
        }

        function getFromCache(key) {
            try {
                const item = JSON.parse(localStorage.getItem(key));
                if (!item) return null;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    localStorage.removeItem(key);
                    return null;
                }
                
                return item.data;
            } catch (error) {
                return null;
            }
        }

        // Gemini API Integration for Document Analysis
        async function analyzeDocumentWithGemini(documentText, companyData) {
            if (!documentText || documentText.trim().length === 0) {
                return 'No document content to analyze.';
            }

            const prompt = `You are a financial analyst specializing in Pre-LOI analysis. Analyze the following company document and provide insights focusing on:

1. Cash Flow Analysis - Profitability indicators
2. Customer Concentration - Key customer dependencies  
3. Revenue Model - Recurring vs one-time revenue
4. Consumability - Purchase frequency patterns
5. Seasonality - Quarterly variations
6. Recession Resistance - Economic sensitivity

Company: ${companyData.name} (${companyData.symbol})
Current Financials: Revenue ${companyData.financials.revenue}, EBITDA Margin ${companyData.financials.ebitdaMargin}

Document Content:
${documentText.substring(0, 8000)} // Limit to 8k chars

Please provide specific, actionable insights in a structured format.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.8,
                            maxOutputTokens: 1000,
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Gemini API Error: ${data.error.message}`);
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Gemini API error:', error);
                return `AI Analysis temporarily unavailable: ${error.message}`;
            }
        }

        // File processing for document analysis
        async function processUploadedFiles() {
            if (uploadedFiles.length === 0) return null;

            let combinedText = '';
            
            for (const file of uploadedFiles) {
                try {
                    const text = await extractTextFromFile(file);
                    combinedText += `\n\n--- ${file.name} ---\n${text}`;
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    combinedText += `\n\n--- ${file.name} ---\nError: Could not extract text from this file.`;
                }
            }

            return combinedText;
        }

        async function extractTextFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const text = event.target.result;
                    resolve(text);
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };

                if (file.type === 'application/pdf') {
                    // For PDFs, you'd need a PDF parsing library like PDF.js
                    // For now, we'll just indicate it's a PDF
                    resolve(`[PDF FILE: ${file.name} - PDF parsing requires additional library. In production, this would extract the full PDF text content.]`);
                } else {
                    // For text files
                    reader.readAsText(file);
                }
            });
        }

        function displayCompanyData(data) {
            const content = document.getElementById('content');
            const trendClass = data.stockInfo.trend === 'up' ? 'trend-up' : 'trend-down';
            const trendIcon = data.stockInfo.trend === 'up' ? '📈' : '📉';
            
            content.innerHTML = `
                <div class="company-card">
                    <div class="company-header">
                        <div>
                            <div class="company-name">${data.name}</div>
                            <div style="margin-top: 10px; font-size: 2rem; font-weight: 600;">
                                ${data.price}
                                <span class="${trendClass}" style="font-size: 1rem; margin-left: 15px;">
                                    ${trendIcon} ${data.change > 0 ? '+' : ''}${data.change} (${data.changePercent > 0 ? '+' : ''}${data.changePercent}%)
                                </span>
                            </div>
                        </div>
                        <div class="company-ticker">${data.symbol}</div>
                    </div>

                    <div class="metrics-section">
                        <h3 class="section-title">📊 Financial Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Revenue (TTM)</div>
                                <div class="metric-value">${data.financials.revenue}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EBITDA</div>
                                <div class="metric-value">${data.financials.ebitda}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EBITDA Margin</div>
                                <div class="metric-value">${data.financials.ebitdaMargin}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Gross Profit</div>
                                <div class="metric-value">${data.financials.grossProfit}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Gross Margin</div>
                                <div class="metric-value">${data.financials.grossMargin}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P/E Ratio</div>
                                <div class="metric-value">${data.stockInfo.peRatio}</div>
                            </div>
                        </div>
                    </div>

                    <div class="stock-chart">
                        <h3 class="section-title">📈 Stock Performance</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">52 Week High</div>
                                <div class="metric-value">${data.stockInfo.high52Week}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">52 Week Low</div>
                                <div class="metric-value">${data.stockInfo.low52Week}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Market Cap</div>
                                <div class="metric-value">${data.stockInfo.marketCap}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Avg Volume</div>
                                <div class="metric-value">${data.stockInfo.avgVolume}</div>
                            </div>
                        </div>
                    </div>

                    ${generatePreLOIAnalysis(data)}

                    ${uploadedFiles.length > 0 ? generateAIAnalysis(data) : ''}
                </div>
            `;
        }

        function generatePreLOIAnalysis(data) {
            const dealScore = calculateDealScore(data);
            const profitabilityRisk = parseFloat(data.financials.ebitdaMargin) > 15 ? 'low' : 
                                    parseFloat(data.financials.ebitdaMargin) > 5 ? 'medium' : 'high';
            const valuationRisk = data.stockInfo.peRatio < 25 ? 'low' : 
                                data.stockInfo.peRatio < 40 ? 'medium' : 'high';
            
            return `
                <div class="pre-loi-section">
                    <h3 class="section-title">🎯 Pre-LOI Analysis</h3>
                    
                    <div class="deal-score">
                        <div style="opacity: 0.8; margin-bottom: 10px;">Overall Deal Score</div>
                        <div class="deal-score-number">${dealScore}</div>
                        <div style="opacity: 0.7; margin-top: 5px;">out of 100</div>
                    </div>

                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <div class="analysis-title">💰 Cash Flow Analysis</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-${profitabilityRisk}">
                                    ${profitabilityRisk === 'low' ? '✅' : profitabilityRisk === 'medium' ? '⚠️' : '❌'} 
                                    ${profitabilityRisk.toUpperCase()} RISK
                                </span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                EBITDA margin of ${data.financials.ebitdaMargin} indicates ${profitabilityRisk === 'low' ? 'strong' : profitabilityRisk === 'medium' ? 'moderate' : 'weak'} profitability. 
                                ${profitabilityRisk === 'low' ? 'Excellent cash generation capability.' : profitabilityRisk === 'medium' ? 'Decent cash flow with room for improvement.' : 'Profitability concerns require attention.'}
                            </p>
                        </div>

                        <div class="analysis-card">
                            <div class="analysis-title">👥 Customer Concentration</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-medium">⚠️ MEDIUM RISK</span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                Large public company likely has diversified customer base. 
                                ${data.symbol === 'AAPL' ? 'Consumer-focused with global market presence.' : 'Industry analysis suggests moderate concentration risk.'}
                            </p>
                        </div>

                        <div class="analysis-card">
                            <div class="analysis-title">🔄 Revenue Model</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-low">✅ LOW RISK</span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                ${data.symbol === 'AAPL' ? 'Mixed model: Hardware sales + recurring services revenue.' : 
                                  data.symbol === 'MSFT' ? 'Strong recurring revenue through subscriptions and cloud services.' : 
                                  'Established business model with predictable revenue streams.'}
                            </p>
                        </div>

                        <div class="analysis-card">
                            <div class="analysis-title">📊 Consumability</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-low">✅ LOW RISK</span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                ${data.symbol === 'AAPL' ? 'High consumer loyalty with regular upgrade cycles.' : 
                                  data.symbol === 'TSLA' ? 'Growing EV market with increasing adoption.' : 
                                  'Strong market position with consistent demand.'}
                            </p>
                        </div>

                        <div class="analysis-card">
                            <div class="analysis-title">📈 Seasonality</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-medium">⚠️ MEDIUM RISK</span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                ${data.symbol === 'AAPL' ? 'Q4 seasonality due to holiday iPhone sales.' : 
                                  data.symbol === 'COST' ? 'Holiday shopping seasons drive higher volumes.' : 
                                  'Some seasonal variations typical for the industry.'}
                            </p>
                        </div>

                        <div class="analysis-card">
                            <div class="analysis-title">🛡️ Recession Resistance</div>
                            <div style="margin: 15px 0;">
                                <span class="risk-indicator risk-${data.symbol === 'COST' ? 'low' : 'medium'}">
                                    ${data.symbol === 'COST' ? '✅ LOW RISK' : '⚠️ MEDIUM RISK'}
                                </span>
                            </div>
                            <p style="opacity: 0.8; font-size: 0.9rem; line-height: 1.5;">
                                ${data.symbol === 'COST' ? 'Membership model provides stability during downturns.' : 
                                  data.symbol === 'MSFT' ? 'Enterprise software essential, relatively recession-resistant.' : 
                                  'Economic sensitivity typical for the sector.'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateAIAnalysis(companyData) {
            const documentText = await processUploadedFiles();
            
            if (!documentText) {
                return `
                    <div style="background: rgba(251, 191, 36, 0.1); border-radius: 16px; padding: 30px; margin-top: 30px; border: 1px solid rgba(251, 191, 36, 0.3);">
                        <h3 style="color: #fcd34d; margin-bottom: 20px;">📄 Document Analysis</h3>
                        <p style="color: #fde68a;">No documents uploaded. Upload CIM, financial reports, or analysis documents to get AI-powered insights.</p>
                    </div>
                `;
            }

            const analysis = await analyzeDocumentWithGemini(documentText, companyData);
            
            return `
                <div style="background: rgba(34, 197, 94, 0.1); border-radius: 16px; padding: 30px; margin-top: 30px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <h3 style="color: #86efac; margin-bottom: 20px;">🤖 AI Document Analysis</h3>
                    <div style="color: #bbf7d0;">
                        <p><strong>Documents Analyzed:</strong> ${uploadedFiles.map(f => f.name).join(', ')}</p>
                        <div style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <h4 style="margin-bottom: 15px;">AI Analysis Results:</h4>
                            <div style="white-space: pre-wrap; line-height: 1.6; font-size: 0.9rem;">
                                ${analysis}
                            </div>
                        </div>
                        <p style="margin-top: 15px; font-size: 0.8rem; opacity: 0.7;">
                            Powered by Google Gemini 2.5 Flash
                        </p>
                    </div>
                </div>
            `;
        }

        function displayError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="error-card">
                    <h3>⚠️ Unable to fetch data</h3>
                    <p>${message}</p>
                    <p style="margin-top: 15px; opacity: 0.8;">
                        <strong>For demo:</strong> Try searching AAPL, TSLA, MSFT, or COST
                    </p>
                </div>
            `;
        }

        function loadCompanyFromPipeline(symbol) {
            document.getElementById('companySearch').value = symbol;
            switchTab('research');
            searchCompany();
        }

        // Enter key functionality
        document.getElementById('companySearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCompany();
            }
        });
    </script>
</body>
</html>